function fh = VEEG(data_in, filters)
%function VEEG(data_in, filters)
% Given the data_in, it loads this data into the SPTool
% INPUT:
% data_in = a cell array. The cell array should be in the follwing order:
%           tsd object or a matrix of data.
%           followed by ts objects for important events in that tsd object
%           another tsd object can follow, again followed by ts objects for
%           events.
% filters = unused at this point
%
% OUTPUT:
%  It opens the SPtool window and allows you to peruse the data. SPTool allows you to filter your data
%  and do power spectrum analyses.
%
%

% cowen
clear global GP
global GP
global fh

if nargin == 0
    data_in = [];
end

if ~iscell(data_in)
  data_in = {data_in};
end

% Set up the globals.
GP.file_count = 0;
GP.file_name = [];
GP.start_ts = 0;
GP.end_ts = 0;
GP.DATA = []; % Stores the data from the most recently loaded data set.
GP.TIME = []; % Stores the time points from the most recently loaded data set.
GP.FS = [];   % Stores the sampling frequency.
GP.POSITION = []; % Position data

fh = figure(...
   'Name','SPTool Wrapper (VEEG)', ...
   'NumberTitle','off', ...   
   'Tag','VEEGMainWindow', ...,
   'Resize', 'Off', ...
   'Units', 'Normalized', ...
   'HandleVisibility', 'Callback');

%-------------------------------
% Alignment variables
%-------------------------------

uicHeight = 0.05;
uicWidth  = 0.25;
dX = 0.3;
XLocs = 0.1:dX:0.9;
dY = 0.05;
YLocs = 0.9:-dY:0.1;
FrameBorder = 0.01;
% Buttons and status
uicontrol('Parent', fh, ... 
   'Units', 'Normalized', 'Position', [XLocs(1)-FrameBorder YLocs(end)-FrameBorder dX 0.85+2*FrameBorder], ...
   'Style', 'frame');

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(1) uicWidth uicHeight], ...
   'Style', 'Text', 'String', 'Load File', 'Tag', 'SPTitle')

uicontrol('Parent', fh, ...  
   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(2) uicWidth/3 uicHeight], ...
   'Style', 'PushButton', 'String', 'EEG',  'Tag', 'LoadEEGFileButton', ...
   'Callback', 'VEEGCallbacks', ...
   'TooltipString', 'EEG')

uicontrol('Parent', fh, ...  
   'Units', 'Normalized', 'Position', [XLocs(1)+uicWidth/3 YLocs(2) uicWidth/3 uicHeight], ...
   'Style', 'PushButton', 'String', '.t',  'Tag', 'LoadTFileButton', ...
   'Callback', 'VEEGCallbacks', ...
   'TooltipString', 'Choose t file.')

uicontrol('Parent', fh, ...  
   'Units', 'Normalized', 'Position', [XLocs(1)+2*uicWidth/3 YLocs(2) uicWidth/3 uicHeight], ...
   'Style', 'PushButton', 'String', 'text time',  'Tag', 'LoadTextTimeFileButton', ...
   'Callback', 'VEEGCallbacks', ...
   'TooltipString', 'Choose text file with timestamps.')

uicontrol('Parent', fh, ...  
   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(3) uicWidth/3 uicHeight], ...
   'Style', 'PushButton', 'String', 'text data',  'Tag', 'LoadTextDataFileButton', ...
   'Callback', 'VEEGCallbacks', ...
   'TooltipString', 'Text data where the first col is the time and the rest are data.')

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1)+1*uicWidth/3 YLocs(3) uicWidth/3 uicHeight], ...
   'Style', 'text', 'String', 'units(s)');

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1)+2*uicWidth/3 YLocs(3) uicWidth/2.5 uicHeight], ...
   'Style', 'edit', 'String', '.000001', 'Tag', 'TSUnitsInSec', ...
   'TooltipString', '');

%------------------------------------------------------------------------------------------

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(4)-uicHeight*.2 uicWidth/2 uicHeight], ...
   'Style', 'text', 'String', 'Start(s)');
uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1)+uicWidth/2  YLocs(4)-uicHeight*.2 uicWidth/2 uicHeight], ...
   'Style', 'text', 'String', 'End(s)');

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(5) uicWidth/2 uicHeight], ...
   'Style', 'edit', 'String', '00:00:00', 'Tag', 'StartTime', ...
   'TooltipString', 'StartTime to load');

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1)+uicWidth/2 YLocs(5) uicWidth/2 uicHeight], ...
   'Style', 'edit', 'String', '00:00:00', 'Tag', 'EndTime', ...
   'TooltipString', 'EndTime to load');

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(6)+uicHeight*.2 uicWidth/2 uicHeight], ...
   'Style', 'text', 'String', '','Tag','GlobalStart');

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1)+uicWidth/2  YLocs(6)+uicHeight*.2   uicWidth/2 uicHeight], ...
   'Style', 'text', 'String', '','Tag','GlobalEnd');
uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(6)-uicHeight*.4 uicWidth/2 uicHeight], ...
   'Style', 'text', 'String', '','Tag','GlobalStartTs');

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1)+uicWidth/2  YLocs(6)-uicHeight*.4  uicWidth/2 uicHeight], ...
   'Style', 'text', 'String', '','Tag','GlobalEndTs');

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(7)-uicHeight*.4   uicWidth/2 uicHeight], ...
   'Style', 'text', 'HorizontalAlignment','left','String', 'Block(min)');

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(8) uicWidth/4 uicHeight], ...
   'Style', 'edit', 'String', '4', 'Tag', 'BlockSizeMin', ...
   'Callback', 'VEEGCallbacks', ...
   'TooltipString', 'Block Size');

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1)+uicWidth/4 YLocs(8) uicWidth/4 uicHeight], ...
   'Style', 'PushButton', 'String', '<--', 'Tag', 'MoveBackward', ...
   'Callback', 'VEEGCallbacks', ...
   'TooltipString', 'Load the data that is in the previous epoch.');

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1)+2*uicWidth/4 YLocs(8) uicWidth/4 uicHeight], ...
   'Style', 'PushButton', 'String', 'Go', 'Tag', 'GoToCurrentTime', ...
   'Callback', 'VEEGCallbacks', ...
   'TooltipString', 'Load the data that is in the previous epoch.');


uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1)+3*uicWidth/4 YLocs(8) uicWidth/4 uicHeight], ...
   'Style', 'PushButton', 'String', '-->', 'Tag', 'MoveForward', ...
   'Callback', 'VEEGCallbacks', ...
   'TooltipString', 'Load the data that is in the next epoch.');

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(10) uicWidth*3/4 uicHeight], ...
   'Style', 'PushButton', 'String', 'Calc Riptimes', 'Tag', 'CalcRiptimes', ...
   'Callback', 'VEEGCallbacks', ...
   'TooltipString', 'Create a new ripple time file.');

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1)+uicWidth*3/4 YLocs(10) uicWidth/4 uicHeight], ...
   'Style', 'edit', 'String', '45', 'Tag', 'RipThreshold', ...
   'TooltipString', 'Threshold');

%uicontrol('Parent', fh, ...
%   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(11)-uicHeight*.4   uicWidth uicHeight], ...
%   'Style', 'text', 'HorizontalAlignment','center','String', 'Vbl from Workspace');

%uicontrol('Parent', fh, ...
%   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(11) uicWidth uicHeight], ...
%   'Style', 'edit', 'String', '', 'Tag', 'ImportVariable', ...
%   'Callback', 'VEEGCallbacks', ...
%   'TooltipString', 'Import a variable from the workspace into SPtool (timestamps, tsd, ts objects).');

uicontrol('Parent', fh, ...  
   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(13) uicWidth*3/4 uicHeight], ...
   'Style', 'CheckBox', 'String', 'Interp sFq:',  'Tag', 'Interpolate', ...
   'Value', 1,  ...
   'TooltipString', 'Interpolate data to assure timestamps in filtered eeg match timestamps in nonfiltered EEG.'); 

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1)+uicWidth*3/4 YLocs(13) uicWidth/4 uicHeight], ...
   'Style', 'edit', 'String', '1000', 'Tag', 'InterpFq', ...
   'TooltipString', 'Desired sampling frequency.');

uicontrol('Parent', fh, ...  
   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(14) uicWidth uicHeight], ...
   'Style', 'CheckBox', 'String', 'Filt 200Hz',  'Tag', 'Filter200Hz', ...
   'Value', 0,  ...
   'TooltipString', 'Filter chosen file at 200hz.'); 

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1)+uicWidth*2/4 YLocs(14) uicWidth/4 uicHeight], ...
   'Style', 'edit', 'String', '100', 'Tag', 'LowRipFq', ...
   'TooltipString', 'Lower ripple frequency cutoff');

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1)+uicWidth*3/4 YLocs(14) uicWidth/4 uicHeight], ...
   'Style', 'edit', 'String', '250', 'Tag', 'HighRipFq', ...
   'TooltipString', 'Upper ripple frequency cutoff');

uicontrol('Parent', fh, ...  
   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(15) uicWidth uicHeight], ...
   'Style', 'CheckBox', 'String', 'Filt 7Hz',  'Tag', 'Filter7Hz', ...
   'Value', 0,  ...
   'TooltipString', 'Filter chosen file at 7hz.'); 

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1)+uicWidth*2/4 YLocs(15) uicWidth/4 uicHeight], ...
   'Style', 'edit', 'String', '6', 'Tag', 'Low7HzFq', ...
   'TooltipString', 'Lower theta frequency cutoff');

uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(1)+uicWidth*3/4 YLocs(15) uicWidth/4 uicHeight], ...
   'Style', 'edit', 'String', '14', 'Tag', 'High7HzFq', ...
   'TooltipString', 'Upper theta frequency cutoff');



uicontrol('Parent', fh, ...  
   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(16) uicWidth uicHeight], ...
   'Style', 'CheckBox', 'String', 'Normalize data [-1 1].',  'Tag', 'Normalize', ...
   'Value', 1,  ...
   'TooltipString', 'Normalize all data to be from -1 to 1.'); 

uicontrol('Parent', fh, ...  
   'Units', 'Normalized', 'Position', [XLocs(1) YLocs(17) uicWidth uicHeight], ...
   'Style', 'CheckBox', 'String', 'Shift matrices.',  'Tag', 'Shift', ...
   'Value', 0,  ...
   'TooltipString', 'Shift the data in the plot so that they dont overlap.'); 

% The second frame
uicontrol('Parent', fh, ... 
   'Units', 'Normalized', 'Position', [XLocs(2)-FrameBorder YLocs(end)-FrameBorder 2*dX 0.85+2*FrameBorder], ...
   'Style', 'frame');
% Calculate spectragram on signal.
uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(2) YLocs(7) 2*uicWidth 6*uicHeight], ...
   'Style', 'listbox', 'String', '', 'Tag', 'FileList', ...
   'Callback', '', ...
   'TooltipString', 'List of loaded files.');


uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(2) YLocs(10) uicWidth uicHeight], ...
   'Style', 'PushButton', 'String', 'Spectragram', 'Tag', 'Spectragram', ...
   'Callback', 'VEEGCallbacks', ...
   'TooltipString', 'Calculate the spectragram');
uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(2) YLocs(11) uicWidth uicHeight], ...
   'Style', 'PushButton', 'String', 'PMTM Spectrum', 'Tag', 'PMTM', ...
   'Callback', 'VEEGCallbacks', ...
   'TooltipString', 'Calculate the PMTM power spectrum with 95% confidence intervals.');
uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(2) YLocs(12) uicWidth uicHeight], ...
   'Style', 'PushButton', 'String', 'Autocorr', 'Tag', 'AutoCorr', ...
   'Callback', 'VEEGCallbacks', ...
   'TooltipString', 'Calculate the autocorrelegram.');
uicontrol('Parent', fh, ...
   'Units', 'Normalized', 'Position', [XLocs(2) YLocs(13) uicWidth uicHeight], ...
   'Style', 'PushButton', 'String', 'Plot Position', 'Tag', 'PlotPosition', ...
   'Callback', 'VEEGCallbacks', ...
   'TooltipString', 'Display the position information for the region of interest.');


% TO ADD
% Clear all variables
% Move to next block (and reload the variables)
% Choose block size.