//////////////////////////////////////////////////////
// Code for delivering a sequence of odors to the headfixed mouse
// Cowen and NS&B Students 2023
//////////////////////////////////////////////////////
int n_solenoids = 4;
//byte solenoid_pins[] = {11, 12, 13}; 
byte solenoid_pins[] = {10, 11, 12}; 
byte neutral_odor_pin = 13;

int sequence_length = 350;
byte odor_sequence[] = {2, 3, 1, 2, 3, 3, 2, 3, 1, 2, 3, 1, 2, 3, 1, 1, 3, 1, 2, 3, 1, 2, 1, 1, 2, 3, 1, 2, 3, 1, 2, 2, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 1, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 1, 3, 1, 2, 3, 1, 2, 3, 1, 1, 3, 1, 2, 3, 1, 2, 3, 2, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 1, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 3, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 3, 2, 3, 3, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 1, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 2, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 3, 3, 1, 3, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 3, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 1, 1, 1, 3, 1, 2, 3, 1, 2, 2, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 3, 3, 1, 2, 1, 1, 1, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 2, 1, 2, 3, 1, 2, 3, 1, 2, 1, 1, 2, 3, 1, 2, 3, 2, 2, 3, 1, 2, 3, 1, 2, 2, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 3, 1, 2, 2, 1, 2, 3};
byte ttl_odor_code_pin = 8;
int ttl_time_ms = 40;  
int port_open_time_ms = 2000;
//int port_closed_time_ms = 50;
int port_to_activate;
int neutral_port_open_time_ms = 3000;
int jittered_neutral_open_time[] = {4584,6392,4534,4691,4195,5414,5602,5504,4961,5529,3032,6926,4200,3409,3686,5529,5569,4722,3619,5211,5019,4243,6089,3372,6227,4626,4124,6830,5408,6714,5268,4742,4040,4830,3308,3983,5991,4142,5342,4074,5770,4250,6606,5440,4511,6729,5351,4844,3850,4157,3484,6054,6798,6682,6768,5225,4316,5174,4008,5688,5230,3614,3526,3869,4228,5634,5199,5727,5590,4494,5211,4805,5150,4239,3444,6002,4380,5244,4469,6248,6719,3836,4992,3263,4215,4808,3527,3425,6879,4473,6172,4516,6949,3913,4278,6669,4320,6577,4282,5322,5632,5145,4854,3088,4044,6008,5740,6597,5434,5873,3590,3781,5554,3701,3938,6597,3293,4131,3167,5192,6985,6559,3631,5880,3387,3239,3810,6350,6944,3225,3069,5003,4070,3684,4434,6005,5345,6540,5258,4836,6409,6933,5687,3557,3748,6301,3325,6847,3605,3253,6723,5170,6393,3351,5999,6810,5086,6418,4972,6527,6809,4473,4171,6996,4831,6517,4690,4717,6580,4526,6258,3179,5447,5702,6331,3774,3072,5159,5877,3978,4426,3022,5594,6427,4391,4437,6612,4292,5957,5709,4223,3277,5059,6843,6675,3858,4686,4716,3339,3320,3306,6624,4300,6467,4885,4977,3217,3049,5437,6321,4494,4232,6035,4000,3583,6379,4904,3411,6192,4757,6078,5573,5007,5494,3101,3709,3176,5563,4461,5263,4776,5918,5181,4426,4719,5752,5583,6361,6465,3745,5727,3115,3166,4817,6087,6472,3114,6249,4965,5930,3514,4257,3572,3204,4200,3224,3466,6679,3271,6159,4118,4535,5161,4709,3028,3710,3685,5785,4277,3155,3233,5903,5382,7000,6157,3417,3736,5565,6987,5906,6890,3282,5530,4746,4981,5357,3706,3935,3896,6969,4226,3053,5505,6443,6261,6207,4438,3307,6797,4811,4074,5939,3251,3304,5875,4899,4831,5067,6437,3459,5664,4649,3827,6527,3887,3541,6154,6105,5972,4147,4894,6794,5870,3185,6418,5687,6811,4444,3058,5827,4188,3743,4251,3321,6891,4375,5431,6287,3091,5415,5793,4045,5535,4554,6537,5301,3788,6379,3563,5327};

void setup() {
  // initialize digital pin LED_BUILTIN as an output.
  Serial.begin(9600);
  Serial.println("STARTED");
  pinMode(neutral_odor_pin, OUTPUT);
  for (int i = 0;i<n_solenoids;i++){
    pinMode(solenoid_pins[i], OUTPUT);
  //  digitalWrite(solenoid_pins[i], LOW);
  }
}

// the loop function runs over and over again forever
void loop() {

    // digitalWrite(ttl_odor_code_pin, HIGH);
    // delay(ttl_time_ms);
    // digitalWrite(ttl_odor_code_pin, LOW);
    // delay(ttl_time_ms);

  for (int i = 0;i<sequence_length;i++){
    port_to_activate = solenoid_pins[odor_sequence[i] - 1];
    Serial.print("Sol ");
    Serial.print(i+1);
    Serial.print(", Pin ");
    Serial.println(port_to_activate);

    // Send a code to Neuropixels to indicate the odor type.
    for (int j = 0;j<odor_sequence[i];j++){
      digitalWrite(ttl_odor_code_pin, HIGH);
      delay(ttl_time_ms);
      digitalWrite(ttl_odor_code_pin, LOW);
      delay(ttl_time_ms);
    }
    // activate the neutral pin
    digitalWrite(port_to_activate, HIGH);
    delay(port_open_time_ms);                     // wait 
    digitalWrite(port_to_activate, LOW);
    //delay(port_closed_time_ms);                   // wait 
     // send out the neutral odor
    digitalWrite(neutral_odor_pin, HIGH);
    //  changing delay to a random  number
    delay(jittered_neutral_open_time[i]);
    Serial.print(jittered_neutral_open_time[i]);
    //delay(neutral_port_open_time_ms);                     // wait
    digitalWrite(neutral_odor_pin, LOW);
    //delay(port_closed_time_ms);                   // wait 
  }
}
